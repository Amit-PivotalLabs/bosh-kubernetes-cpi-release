# abort script on any command that exits with a non zero value
set -e

BUILD_DIR=$PWD
BOSH_PACKAGES_DIR=${BOSH_PACKAGES_DIR:-/var/vcap/packages}
STACK="$BOSH_PACKAGES_DIR/stack/stack"
TMP_HOME=$(mktemp -d)
export STACK_ROOT=$TMP_HOME/stack
mkdir -p $STACK_ROOT

pushd $STACK_ROOT
  tar xzf $BUILD_DIR/bosh_kubernetes_cpi/dependencies.source.tgz -C $STACK_ROOT
popd

pushd bosh-kubernetes-cpi
#  $STACK setup
  HOME=$TMP_HOME $STACK build --install-ghc
  cp $(HOME=$TMP_HOME $STACK exec which bosh-kubernetes-cpi) ${BOSH_INSTALL_TARGET}
popd

rm -rf $TMP_HOME
